{% extends "base.html" %}

{% block title %}Dashboard - {{ hospital_name }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2><i class="fas fa-tachometer-alt"></i> Dashboard - {{ hospital_name }}</h2>
        <p class="text-muted">Hospital ID: {{ hospital_id }}</p>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5>{{ datasets|length }}</h5>
                        <p class="mb-0">Datasets</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-database fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5>{{ models|length }}</h5>
                        <p class="mb-0">Models</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-brain fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 id="totalSamples">0</h5>
                        <p class="mb-0">Total Samples</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-chart-bar fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 id="trainingStatus">Ready</h5>
                        <p class="mb-0">Status</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-cog fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-bolt"></i> Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <a href="{{ url_for('upload_data') }}" class="btn btn-primary w-100 mb-2">
                            <i class="fas fa-upload"></i><br>Upload Dataset
                        </a>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-success w-100 mb-2" onclick="startTraining()">
                            <i class="fas fa-play"></i><br>Start Training
                        </button>
                    </div>
                    <div class="col-md-3">
                        <a href="{{ url_for('predict') }}" class="btn btn-info w-100 mb-2">
                            <i class="fas fa-brain"></i><br>Make Prediction
                        </a>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-secondary w-100 mb-2" onclick="downloadModel()">
                            <i class="fas fa-download"></i><br>Download Model
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Datasets -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-database"></i> Your Datasets</h5>
                <a href="{{ url_for('upload_data') }}" class="btn btn-sm btn-primary">
                    <i class="fas fa-plus"></i> Add Dataset
                </a>
            </div>
            <div class="card-body">
                {% if datasets %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Filename</th>
                                <th>Samples</th>
                                <th>Features</th>
                                <th>Target Column</th>
                                <th>Uploaded</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for dataset in datasets %}
                            <tr>
                                <td>{{ dataset.original_filename }}</td>
                                <td>{{ dataset.num_samples }}</td>
                                <td>{{ dataset.num_features }}</td>
                                <td><code>{{ dataset.target_column }}</code></td>
                                <td>{{ dataset.uploaded_at[:10] }}</td>
                                <td>
                                    <button class="btn btn-sm btn-info" onclick="viewDataset('{{ dataset.filename }}')">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-database fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No datasets uploaded yet.</p>
                    <a href="{{ url_for('upload_data') }}" class="btn btn-primary">
                        <i class="fas fa-upload"></i> Upload Your First Dataset
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Training Progress -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-line"></i> Training Progress</h5>
            </div>
            <div class="card-body">
                <div id="trainingChart" style="height: 300px;">
                    <canvas id="progressChart"></canvas>
                </div>
                <div id="noTrainingData" class="text-center py-4" style="display: none;">
                    <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No training sessions yet.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Training Session Modal -->
<div class="modal fade" id="trainingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-cog"></i> Start Training Session</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="trainingForm">
                    <div class="mb-3">
                        <label for="sessionName" class="form-label">Session Name</label>
                        <input type="text" class="form-control" id="sessionName" 
                               value="Training_{{ hospital_id }}_">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Training Parameters</label>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="localEpochs" class="form-label">Local Epochs</label>
                                <input type="number" class="form-control" id="localEpochs" value="5" min="1" max="20">
                            </div>
                            <div class="col-md-6">
                                <label for="globalRounds" class="form-label">Global Rounds</label>
                                <input type="number" class="form-control" id="globalRounds" value="10" min="1" max="50">
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Note:</strong> Training will start when at least 2 hospitals are ready.
                        Your data remains private throughout the process.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="submitTraining()">
                    <i class="fas fa-play"></i> Start Training
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Calculate total samples from server-side data
let totalSamples = 0;
let datasets = [];

// Get datasets from server-side template
try {
    datasets = JSON.parse('{{ datasets | tojson | safe }}');
    if (datasets && datasets.length > 0) {
        datasets.forEach(dataset => {
            totalSamples += dataset.num_samples || 0;
        });
    }
} catch (e) {
    console.log('No datasets available');
    datasets = [];
}

document.getElementById('totalSamples').textContent = totalSamples;

// Initialize chart
let progressChart = null;

function initChart() {
    const ctx = document.getElementById('progressChart').getContext('2d');
    progressChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Training Accuracy',
                data: [],
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1
            }, {
                label: 'Test Accuracy',
                data: [],
                borderColor: 'rgb(255, 99, 132)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
}

function startTraining() {
    const hasDatasets = datasets && datasets.length > 0;
    if (hasDatasets) {
        // Generate timestamp for session name
        const now = new Date();
        const timestamp = now.getFullYear().toString() + 
                         (now.getMonth() + 1).toString().padStart(2, '0') + 
                         now.getDate().toString().padStart(2, '0') + '_' +
                         now.getHours().toString().padStart(2, '0') + 
                         now.getMinutes().toString().padStart(2, '0') + 
                         now.getSeconds().toString().padStart(2, '0');
        
        document.getElementById('sessionName').value = 'Training_{{ hospital_id }}_' + timestamp;
        new bootstrap.Modal(document.getElementById('trainingModal')).show();
    } else {
        alert('Please upload at least one dataset before starting training.');
    }
}

async function submitTraining() {
    const sessionName = document.getElementById('sessionName').value;
    
    try {
        const response = await fetch('/api/start_training', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                session_name: sessionName
            })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('trainingModal')).hide();
            alert('Training session started successfully!');
            // Start polling for updates
            pollTrainingStatus(result.session_id);
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        alert('Network error: ' + error.message);
    }
}

function pollTrainingStatus(sessionId) {
    // Poll every 5 seconds for training updates
    const interval = setInterval(async () => {
        try {
            const response = await fetch(`/api/training_status/${sessionId}`);
            const status = await response.json();
            
            if (response.ok) {
                updateTrainingStatus(status);
                
                if (status.status === 'completed' || status.status === 'failed') {
                    clearInterval(interval);
                }
            }
        } catch (error) {
            console.error('Error polling training status:', error);
        }
    }, 5000);
}

function updateTrainingStatus(status) {
    document.getElementById('trainingStatus').textContent = status.status;
    
    // Update chart if there's history
    if (status.history && status.history.length > 0) {
        // Update chart with new data
        // This would be implemented based on the actual training history format
    }
}

function viewDataset(filename) {
    // Show dataset details modal
    alert('Dataset viewer not implemented yet. Filename: ' + filename);
}

function downloadModel() {
    alert('Model download not implemented yet.');
}

// Initialize chart on page load
document.addEventListener('DOMContentLoaded', function() {
    initChart();
});
</script>
{% endblock %}
