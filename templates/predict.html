{% extends "base.html" %}

{% block title %}Make Prediction - Federated Learning Platform{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="card shadow">
            <div class="card-header bg-info text-white">
                <h4><i class="fas fa-brain"></i> Make Prediction</h4>
            </div>
            <div class="card-body">
                <!-- Prediction Form -->
                <form id="predictionForm">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6><i class="fas fa-cog"></i> Input Method</h6>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="inputMethod" id="manualInput" value="manual" checked>
                                <label class="form-check-label" for="manualInput">
                                    Manual Input
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="inputMethod" id="csvInput" value="csv">
                                <label class="form-check-label" for="csvInput">
                                    CSV File Upload
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-info-circle"></i> Model Status</h6>
                            <div id="modelStatus" class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                Checking model availability...
                            </div>
                        </div>
                    </div>
                    
                    <!-- Manual Input Section -->
                    <div id="manualInputSection">
                        <h6><i class="fas fa-keyboard"></i> Enter Feature Values</h6>
                        <div id="featureInputs" class="row">
                            <!-- Dynamic feature inputs will be generated here -->
                        </div>
                        <div class="text-center mt-3">
                            <button type="button" class="btn btn-secondary" onclick="loadSampleData()">
                                <i class="fas fa-flask"></i> Load Sample Data
                            </button>
                        </div>
                    </div>
                    
                    <!-- CSV Input Section -->
                    <div id="csvInputSection" style="display: none;">
                        <h6><i class="fas fa-file-csv"></i> Upload CSV for Batch Prediction</h6>
                        <div class="mb-3">
                            <input type="file" class="form-control" id="predictionFile" accept=".csv">
                            <div class="form-text">
                                Upload a CSV file with the same features as your training data (without target column).
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-info btn-lg" id="predictButton" disabled>
                            <i class="fas fa-brain"></i> Make Prediction
                        </button>
                    </div>
                </form>
                
                <!-- Prediction Results -->
                <div id="predictionResults" class="mt-4" style="display: none;">
                    <div class="card border-success">
                        <div class="card-header bg-success text-white">
                            <h5><i class="fas fa-chart-pie"></i> Prediction Results</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Predicted Class</h6>
                                    <div class="alert alert-success">
                                        <h4 id="predictedClass" class="mb-0">-</h4>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6>Confidence</h6>
                                    <div class="progress mb-2" style="height: 30px;">
                                        <div id="confidenceBar" class="progress-bar bg-success" role="progressbar" style="width: 0%">
                                            <span id="confidenceText">0%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <h6>Class Probabilities</h6>
                                <canvas id="probabilityChart" width="400" height="200"></canvas>
                            </div>
                            
                            <div class="mt-3">
                                <small class="text-muted">
                                    <i class="fas fa-clock"></i> Prediction made at: <span id="predictionTime">-</span>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Batch Results -->
                <div id="batchResults" class="mt-4" style="display: none;">
                    <div class="card border-info">
                        <div class="card-header bg-info text-white">
                            <h5><i class="fas fa-table"></i> Batch Prediction Results</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Row</th>
                                            <th>Prediction</th>
                                            <th>Confidence</th>
                                        </tr>
                                    </thead>
                                    <tbody id="batchResultsBody">
                                    </tbody>
                                </table>
                            </div>
                            <div class="text-center mt-3">
                                <button class="btn btn-success" onclick="downloadResults()">
                                    <i class="fas fa-download"></i> Download Results
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Model Information -->
        <div class="card mt-4">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> Model Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <strong>Model Type:</strong><br>
                        <span class="text-muted">Federated Neural Network</span>
                    </div>
                    <div class="col-md-4">
                        <strong>Privacy Level:</strong><br>
                        <span class="text-success">High (Input Adapter Private)</span>
                    </div>
                    <div class="col-md-4">
                        <strong>Last Updated:</strong><br>
                        <span class="text-muted" id="modelLastUpdated">-</span>
                    </div>
                </div>
                
                <div class="mt-3">
                    <div class="alert alert-info">
                        <i class="fas fa-shield-alt"></i>
                        <strong>Privacy Notice:</strong> Predictions are made using your private input adapter. 
                        Your feature space and input data remain completely confidential.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let modelAvailable = false;
let featureNames = [];
let probabilityChart = null;

// Sample data for demonstration
const sampleData = {
    'Age': 45,
    'Gender': 1,
    'Heart rate': 72,
    'Systolic blood pressure': 120,
    'Diastolic blood pressure': 80,
    'Blood sugar': 95,
    'CK-MB': 2.5,
    'Troponin': 0.01
};

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    checkModelStatus();
    setupInputMethodToggle();
    generateFeatureInputs();
    initProbabilityChart();
});

function checkModelStatus() {
    // Simulate model status check
    setTimeout(() => {
        const statusDiv = document.getElementById('modelStatus');
        // For demo, assume model is available
        modelAvailable = true;
        
        if (modelAvailable) {
            statusDiv.className = 'alert alert-success';
            statusDiv.innerHTML = '<i class="fas fa-check-circle"></i> Model ready for predictions';
            document.getElementById('predictButton').disabled = false;
            document.getElementById('modelLastUpdated').textContent = new Date().toLocaleString();
        } else {
            statusDiv.className = 'alert alert-danger';
            statusDiv.innerHTML = '<i class="fas fa-times-circle"></i> No trained model found. Please train first.';
        }
    }, 1000);
}

function setupInputMethodToggle() {
    document.querySelectorAll('input[name="inputMethod"]').forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'manual') {
                document.getElementById('manualInputSection').style.display = 'block';
                document.getElementById('csvInputSection').style.display = 'none';
            } else {
                document.getElementById('manualInputSection').style.display = 'none';
                document.getElementById('csvInputSection').style.display = 'block';
            }
        });
    });
}

function generateFeatureInputs() {
    // Use sample feature names (in real app, get from server)
    featureNames = Object.keys(sampleData);
    
    const container = document.getElementById('featureInputs');
    container.innerHTML = '';
    
    featureNames.forEach((feature, index) => {
        const col = document.createElement('div');
        col.className = 'col-md-6 mb-3';
        
        col.innerHTML = `
            <label for="feature_${index}" class="form-label">${feature}</label>
            <input type="number" class="form-control" id="feature_${index}" 
                   name="${feature}" step="any" placeholder="Enter ${feature}">
        `;
        
        container.appendChild(col);
    });
}

function loadSampleData() {
    featureNames.forEach((feature, index) => {
        const input = document.getElementById(`feature_${index}`);
        input.value = sampleData[feature];
    });
}

function initProbabilityChart() {
    const ctx = document.getElementById('probabilityChart').getContext('2d');
    probabilityChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Negative', 'Positive'],
            datasets: [{
                label: 'Probability',
                data: [0, 0],
                backgroundColor: ['#dc3545', '#28a745'],
                borderColor: ['#dc3545', '#28a745'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 1,
                    ticks: {
                        callback: function(value) {
                            return (value * 100).toFixed(0) + '%';
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

// Form submission
document.getElementById('predictionForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    if (!modelAvailable) {
        alert('Model not available. Please train first.');
        return;
    }
    
    const inputMethod = document.querySelector('input[name="inputMethod"]:checked').value;
    
    if (inputMethod === 'manual') {
        await makeSinglePrediction();
    } else {
        await makeBatchPrediction();
    }
});

async function makeSinglePrediction() {
    // Collect feature values
    const features = {};
    featureNames.forEach((feature, index) => {
        const input = document.getElementById(`feature_${index}`);
        features[feature] = parseFloat(input.value) || 0;
    });
    
    try {
        // Simulate API call (replace with actual API call)
        const mockPrediction = {
            class: Math.random() > 0.5 ? 'positive' : 'negative',
            confidence: 0.75 + Math.random() * 0.24,
            probabilities: {
                negative: Math.random() * 0.5,
                positive: 0.5 + Math.random() * 0.5
            }
        };
        
        // Normalize probabilities
        const total = mockPrediction.probabilities.negative + mockPrediction.probabilities.positive;
        mockPrediction.probabilities.negative /= total;
        mockPrediction.probabilities.positive /= total;
        mockPrediction.confidence = Math.max(mockPrediction.probabilities.negative, mockPrediction.probabilities.positive);
        
        displaySingleResult(mockPrediction);
        
    } catch (error) {
        alert('Prediction error: ' + error.message);
    }
}

async function makeBatchPrediction() {
    const fileInput = document.getElementById('predictionFile');
    
    if (!fileInput.files[0]) {
        alert('Please select a CSV file');
        return;
    }
    
    // Simulate batch prediction
    const mockResults = [];
    for (let i = 0; i < 10; i++) {
        mockResults.push({
            row: i + 1,
            prediction: Math.random() > 0.5 ? 'positive' : 'negative',
            confidence: (0.6 + Math.random() * 0.4).toFixed(3)
        });
    }
    
    displayBatchResults(mockResults);
}

function displaySingleResult(result) {
    // Update predicted class
    document.getElementById('predictedClass').textContent = result.class;
    
    // Update confidence bar
    const confidence = (result.confidence * 100).toFixed(1);
    document.getElementById('confidenceBar').style.width = confidence + '%';
    document.getElementById('confidenceText').textContent = confidence + '%';
    
    // Update probability chart
    probabilityChart.data.datasets[0].data = [
        result.probabilities.negative,
        result.probabilities.positive
    ];
    probabilityChart.update();
    
    // Update timestamp
    document.getElementById('predictionTime').textContent = new Date().toLocaleString();
    
    // Show results
    document.getElementById('predictionResults').style.display = 'block';
    document.getElementById('batchResults').style.display = 'none';
    
    // Scroll to results
    document.getElementById('predictionResults').scrollIntoView({ behavior: 'smooth' });
}

function displayBatchResults(results) {
    const tbody = document.getElementById('batchResultsBody');
    tbody.innerHTML = '';
    
    results.forEach(result => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${result.row}</td>
            <td>
                <span class="badge bg-${result.prediction === 'positive' ? 'success' : 'danger'}">
                    ${result.prediction}
                </span>
            </td>
            <td>${(result.confidence * 100).toFixed(1)}%</td>
        `;
        tbody.appendChild(row);
    });
    
    // Show batch results
    document.getElementById('batchResults').style.display = 'block';
    document.getElementById('predictionResults').style.display = 'none';
    
    // Scroll to results
    document.getElementById('batchResults').scrollIntoView({ behavior: 'smooth' });
}

function downloadResults() {
    alert('Download functionality not implemented yet.');
}
</script>
{% endblock %}
