{% extends "base.html" %}

{% block title %}Upload Dataset - Federated Learning Platform{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h4><i class="fas fa-upload"></i> Upload Dataset</h4>
            </div>
            <div class="card-body">
                <!-- Upload Form -->
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="mb-4">
                        <label for="file" class="form-label">CSV Dataset File</label>
                        <input type="file" class="form-control" id="file" name="file" accept=".csv" required>
                        <div class="form-text">
                            <i class="fas fa-info-circle"></i> 
                            Maximum file size: 50MB. Only CSV files are accepted.
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="target_column" class="form-label">Target Column Name</label>
                        <input type="text" class="form-control" id="target_column" name="target_column" required
                               placeholder="e.g., diagnosis, outcome, result">
                        <div class="form-text">
                            The name of the column containing the labels/outcomes you want to predict.
                        </div>
                    </div>
                    
                    <!-- File Preview -->
                    <div id="filePreview" class="mb-4" style="display: none;">
                        <h6><i class="fas fa-eye"></i> File Preview</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead id="previewHeader"></thead>
                                <tbody id="previewBody"></tbody>
                            </table>
                        </div>
                        <div id="fileStats" class="row text-center">
                            <div class="col-md-3">
                                <div class="border rounded p-2">
                                    <strong id="rowCount">0</strong><br>
                                    <small class="text-muted">Rows</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="border rounded p-2">
                                    <strong id="colCount">0</strong><br>
                                    <small class="text-muted">Columns</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="border rounded p-2">
                                    <strong id="fileSize">0</strong><br>
                                    <small class="text-muted">Size</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="border rounded p-2">
                                    <strong id="missingValues">0</strong><br>
                                    <small class="text-muted">Missing</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Privacy Notice -->
                    <div class="alert alert-info">
                        <h6><i class="fas fa-shield-alt"></i> Privacy & Security</h6>
                        <ul class="mb-0">
                            <li>Your data is processed locally and securely</li>
                            <li>Only model parameters are shared, never raw data</li>
                            <li>Files are scanned for malicious content</li>
                            <li>Data is automatically normalized and validated</li>
                        </ul>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-upload"></i> Upload Dataset
                        </button>
                    </div>
                </form>
                
                <!-- Upload Progress -->
                <div id="uploadProgress" class="mt-3" style="display: none;">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="text-center mt-2">
                        <small id="uploadStatus">Uploading...</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Data Requirements -->
        <div class="card mt-4">
            <div class="card-header">
                <h5><i class="fas fa-list-check"></i> Dataset Requirements</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-success"><i class="fas fa-check"></i> Supported Formats</h6>
                        <ul>
                            <li>CSV files with headers</li>
                            <li>Numeric and categorical features</li>
                            <li>String or numeric labels</li>
                            <li>UTF-8 encoding</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-info"><i class="fas fa-info"></i> Automatic Processing</h6>
                        <ul>
                            <li>Missing value handling</li>
                            <li>Categorical variable encoding</li>
                            <li>Feature normalization</li>
                            <li>Train/test splitting</li>
                        </ul>
                    </div>
                </div>
                
                <div class="mt-3">
                    <h6 class="text-warning"><i class="fas fa-exclamation-triangle"></i> Minimum Requirements</h6>
                    <ul class="mb-0">
                        <li>At least 10 samples (rows)</li>
                        <li>At least 2 columns (features + target)</li>
                        <li>Less than 50% missing values</li>
                        <li>Valid target column name</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let csvData = null;

// File input change handler
document.getElementById('file').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        previewFile(file);
    }
});

function previewFile(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const csv = e.target.result;
            const lines = csv.split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            
            // Show file stats
            document.getElementById('rowCount').textContent = lines.length - 1;
            document.getElementById('colCount').textContent = headers.length;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            
            // Show preview table
            const headerRow = document.getElementById('previewHeader');
            headerRow.innerHTML = '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
            
            const bodyRows = document.getElementById('previewBody');
            bodyRows.innerHTML = '';
            
            // Show first 5 rows
            for (let i = 1; i <= Math.min(5, lines.length - 1); i++) {
                if (lines[i].trim()) {
                    const cells = lines[i].split(',').map(c => c.trim());
                    const row = document.createElement('tr');
                    row.innerHTML = cells.map(c => `<td>${c}</td>`).join('');
                    bodyRows.appendChild(row);
                }
            }
            
            // Populate target column suggestions
            const targetSelect = document.getElementById('target_column');
            targetSelect.setAttribute('list', 'columnSuggestions');
            
            let datalist = document.getElementById('columnSuggestions');
            if (!datalist) {
                datalist = document.createElement('datalist');
                datalist.id = 'columnSuggestions';
                targetSelect.parentNode.appendChild(datalist);
            }
            
            datalist.innerHTML = headers.map(h => `<option value="${h}">`).join('');
            
            document.getElementById('filePreview').style.display = 'block';
            
        } catch (error) {
            alert('Error reading file: ' + error.message);
        }
    };
    reader.readAsText(file);
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Form submission
document.getElementById('uploadForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData();
    const fileInput = document.getElementById('file');
    const targetColumn = document.getElementById('target_column').value;
    
    if (!fileInput.files[0]) {
        alert('Please select a file');
        return;
    }
    
    if (!targetColumn) {
        alert('Please specify the target column name');
        return;
    }
    
    formData.append('file', fileInput.files[0]);
    formData.append('target_column', targetColumn);
    
    // Show progress
    document.getElementById('uploadProgress').style.display = 'block';
    const progressBar = document.querySelector('.progress-bar');
    const statusText = document.getElementById('uploadStatus');
    
    try {
        // Simulate progress (in real implementation, use XMLHttpRequest for progress tracking)
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += Math.random() * 20;
            if (progress > 90) progress = 90;
            progressBar.style.width = progress + '%';
        }, 200);
        
        const response = await fetch('{{ url_for("upload_data") }}', {
            method: 'POST',
            body: formData
        });
        
        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        
        const result = await response.json();
        
        if (response.ok) {
            statusText.textContent = 'Upload successful!';
            progressBar.classList.remove('progress-bar-animated');
            progressBar.classList.add('bg-success');
            
            setTimeout(() => {
                alert('Dataset uploaded successfully!\n\n' +
                      'Samples: ' + result.dataset_info.num_samples + '\n' +
                      'Features: ' + result.dataset_info.num_features + '\n' +
                      'Target: ' + result.dataset_info.target_column);
                window.location.href = '{{ url_for("dashboard") }}';
            }, 1000);
        } else {
            statusText.textContent = 'Upload failed: ' + result.error;
            progressBar.classList.add('bg-danger');
        }
    } catch (error) {
        statusText.textContent = 'Network error: ' + error.message;
        progressBar.classList.add('bg-danger');
    }
});
</script>
{% endblock %}
